layout: post
title: å¿«ä¸€ç‚¹, å†å¿«ä¸€ç‚¹
date: 2018-09-04
tags: js
---

è¯è¯´ï¼Œæœ€è¿‘é¡¹ç›®çš„å¼€å‘ç¯å¢ƒå‡çº§ï¼Œå¼•å…¥äº† js æ„å»ºå·¥å…· webpackï¼Œç”Ÿäº§åŠ›å¤§å¤§æé«˜ï¼Œhappy äº†ä¸¤ä¸ªæœˆåï¼Œéšç€é¡¹ç›®ä»£ç é€æ—¥å¢å¤šï¼Œæˆ‘ä»¬é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæ„å»ºå¤ªæ…¢äº†ã€‚æ…¢åˆ°ä»€ä¹ˆç¨‹åº¦å‘¢ï¼Œå¼€å‘æ—¶ç¬¬ä¸€æ¬¡å¯åŠ¨è¦40ç§’å·¦å³ï¼Œç”Ÿäº§æ„å»ºåˆ™éœ€è¦1åˆ†å¤šé’Ÿç”šè‡³2åˆ†é’Ÿã€‚çœ‹ç€ä¼¼ä¹ä¸æ˜¯ç‰¹åˆ«æ…¢hoï¼Œä½ å¯ä»¥è¯•ç€å‡ºäº† bug åå’Œ pmï¼Œ æµ‹è¯•ï¼Œè®¾è®¡å°å§å§æ³¨è§†2åˆ†é’Ÿâ€¦

> äººç”Ÿè‹¦çŸ­ // æˆ‘ç”¨ pythonï¼Œä¸€åˆ»åƒé‡‘ã€‚å¤§å¥½æ—¶å…‰æ€ä¹ˆå¯ä»¥æŠŠæ—¶é—´æµªè´¹åœ¨æ„å»ºä¸Šå‘¢ï¼Ÿsoï¼Œå¿«ä¸€ç‚¹ï¼Œå†å¿«ä¸€ç‚¹ï¼

#### åˆ†æ
æˆ‘ä»¬æ˜¯å¤šé¡µé¢åº”ç”¨ï¼Œæ‹¥æœ‰å¾ˆå¤šå…¥å£ï¼Œæ„å»ºå·¥å…·éœ€è¦å»éå†æŒ‡å®šæ–‡ä»¶å¤¹å†…çš„æŒ‡å®š js æ–‡ä»¶å¹¶ç”Ÿæˆå¯¹åº”çš„ html æ–‡ä»¶å‡ºæ¥ï¼Œç„¶åæˆ‘ä»¬æœ‰ rename çš„éœ€æ±‚ï¼Œå³ç”Ÿæˆçš„ html çš„æ–‡ä»¶åå¯ä»¥å’Œ js æ–‡ä»¶åä¸ä¸€è‡´ã€‚
äºæ˜¯æˆ‘ä»¬åœ¨ js é‡Œæä¾›äº†ä¸€ä¸ªç‰¹å®šè¯­å¥ï¼š
```javascript
// card/index.js
@Entry({
    filename: 'card_list.html'
})
````
ç„¶ååœ¨ç¼–è¯‘æ—¶é€šè¿‡ babel parse å‡º ast åæ‹¿åˆ° filename çš„å€¼ï¼Œå†äº¤ç»™ webpack ã€‚
è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¼€å‘æ—¶èƒ½å¤Ÿç›´è§‚çš„è®¾ç½®æ–‡ä»¶åç§°ï¼Œåç»­ç»´æŠ¤çš„æ—¶å€™ä¹Ÿå¾ˆç›´è§‚çš„çŸ¥é“æœ€ç»ˆè¾“å‡ºçš„æ–‡ä»¶åç§°ã€‚æ—¶é—´ä¸Šçš„æ¶ˆè€—åœ¨é¡¹ç›®åˆæœŸä»£ç ä¸æ˜¯å¾ˆå¤šï¼Œjs æ–‡ä»¶ä¸æ˜¯å¾ˆå¤§çš„æ—¶å€™ä¹Ÿè¿˜æ˜¯å¯ä»¥æ¥å—çš„ã€‚ä½†å½“ js æ–‡ä»¶è¶Šæ¥è¶Šå¤šï¼Œè¶Šæ¥è¶Šå¤§ï¼Œå°±æœ‰ç‚¹è®©äººå¤´ç–¼äº†ã€‚è€Œä¸”ä¸ºäº†æ»¡è¶³å°±è¿‘åŸåˆ™ï¼Œæˆ‘ä»¬ä¼šæŠŠå…¬ç”¨çš„ä¸šåŠ¡é€»è¾‘æŠ½å‡ºæ¥æ”¾åœ¨åŒæ–‡ä»¶å¤¹å†…ï¼Œå°±ä¼šæµªè´¹å¾ˆå¤šæ—¶é—´åœ¨è¿™äº›é entry æ–‡ä»¶ä¸Šã€‚

#### ç»“è®º
æ‰€ä»¥ç»“è®ºå°±æ˜¯ï¼šast å¥½ç”¨ï¼Œä½†æ˜¯æœ‰ç‚¹èŠ±æ—¶é—´ã€‚

#### åŠ é€Ÿ
ç§‰ç€è°æ‹–åè…¿å°±å¹²æ‰è°çš„åŸåˆ™ï¼Œé¦–å…ˆ babel parse to ast è¿™ä¸ªæˆ‘ä»¬å°±åˆ«è¦äº†ï¼Œæ‰¾ä¸ªå…¶ä»–èƒ½æ»¡è¶³æˆ‘ä»¬éœ€æ±‚çš„åŠæ³•ï¼Œæœ‰æ²¡æœ‰å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œè€Œä¸”å°±è¿‘åœ¨çœ¼å‰ã€‚ç”¨è¿‡ gulp çš„åŒå­¦è‚¯å®šéƒ½è§è¿‡è¿™è¡Œä»£ç ï¼š`gulp.src('client/templates/*.jade')Â `[gulp api](http://www.gulpjs.com.cn/docs/api/)ï¼Œè¿™é‡Œçš„åŒ¹é…è§„åˆ™ä½¿ç”¨çš„[node-glob](https://github.com/isaacs/node-glob)ã€‚glob åœ¨åŒ¹é…ç‰¹å®šæ–‡ä»¶æ—¶éå¸¸æ–¹ä¾¿ï¼Œä¸”æ”¯æŒignoreï¼Œç”¨æ¥åŒ¹é…æˆ‘ä»¬çš„ entry å®åœ¨å¤ªåˆé€‚ä¸è¿‡äº†ã€‚ä¸‹é¢æ˜¯è·å– entries çš„ä¾‹å­ï¼š 
```javascript
function getEntries(dir = 'src/pages') {
    const entries = {}
    const root = resolve(dir) + '/'
    const files = glob.sync(root + '**/*.js', {
    ignore: [
        '**/view.js',
        '**/_*/**', 
        '_*.js'
    ]
    })

    files.forEach((file) => {
    entries[
        file
        .replace(root, '')
        .replace('/index.js', '')
        .replace(/\//g, '_')
        .replace('.js', '')
    ] = file
    })

    return entries
}
```
è¿™é‡Œæˆ‘ä»¬é€šè¿‡ç‰¹å®šçš„ç±»ä¼¼ sass ä¸­çš„åšæ³•çº¦å®šé entry æ–‡ä»¶ä½¿ç”¨`_`å‰ç¼€ä»¥å¿½ç•¥ã€‚å¹¶æ ¹æ®æ–‡ä»¶çš„è·¯å¾„ç”Ÿæˆ `{dir_filename: absolutePath}Â ` è¿™æ ·çš„ entries ç»™ webpackã€‚åŒæ—¶ï¼Œä¸ºäº†æ»¡è¶³ rename çš„éœ€æ±‚ï¼Œå…è®¸æä¾›ä¸€ä¸ª router.js æ–‡ä»¶æ¥å®šä¹‰éœ€è¦ rename çš„ entryï¼Œç±»ä¼¼ï¼š
```js
	// router.js
	module.exports = {
	  rename: require.resolve(filePath)
	}
```
ç„¶åé€šè¿‡ä¸‹é¢çš„æ–¹æ³•å¯¹åŸå§‹ entry å’Œ router è¿›è¡Œ merge:
```js
function mergeEntries(entry, router) {
    const reducer = (prev, [key, val]) => {
    prev[val] = key
    return prev
    }
    const reverse = source => Object
    .entries(source)
    .reduce(reducer, {})

    return reverse(reverse(Object.assign({}, entry, router)))
}
```
ç„¶åæŠŠæœ€ç»ˆçš„ entries äº¤ç»™ webpack å°± ok äº†ã€‚

#### å†å¿«ä¸€ç‚¹
åŸæ¥çš„ webpack ä½¿ç”¨çš„æ˜¯ v1.x ç‰ˆæœ¬ï¼Œæœ€è¿‘ webpack å·²ç»å‘å¸ƒäº†3.x çš„ç‰ˆæœ¬ï¼Œæ›´åŠ çš„ powerfulã€‚äºæ˜¯æˆ‘ä¾¿å°†ä¾èµ–ä¹Ÿå‡çº§åˆ°æœ€æ–°çš„ v3.5.5ï¼Œç„¶åå‚»çœ¼äº†ã€‚åœ¨å¤š entry çš„æƒ…å†µä¸‹ï¼Œwebpack3 ä¸æœ€æ–°çš„ html-webpack-plugin é…åˆèµ·æ¥å¹¶ä¸é»˜å¥‘ã€‚ã€‚ä¼šå¯¼è‡´æ„å»ºæ—¶é—´å‡ ä½•ç¿»å€ï¼Œè¯¦ç»†çœ‹å¯ä»¥çœ‹è¿™ä¸ª[issue](https://github.com/jantimon/html-webpack-plugin/issues/724)ã€‚  
åœ¨è¿™ä¸ª issue é‡Œæˆ‘å‘ç°äº†ä¸ªæœ‰æ„æ€çš„ä¸œè¥¿ï¼Œå°±æ˜¯ html-webpack-plugin çš„ v1.7.0 ç‰ˆæœ¬ç®€ç›´ä¸è¦å¤ªå¿«ï¼Œé™çº§åˆ° v1.7.0 åæ„å»ºé€Ÿåº¦æœç„¶é£èµ·æ¥äº†ï¼Œæ¯”èµ· 2.x éƒ½è¦å¿«å¾ˆå¤šã€‚ä½†æ˜¯å®ƒä¸æ”¯æŒ`chunksSortMode: dependencyÂ `ï¼Œæ„å‘³è€…å½“ä½ åœ¨ç”Ÿäº§æ„å»ºæ—¶ä½¿ç”¨äº†`CommonsChunkPlugin`åå°†æ— æ³•æ­£ç¡®çš„æ’åˆ— js çš„å¼•å…¥é¡ºåºã€‚ä¸è¿‡å¥½åœ¨å®ƒæ”¯æŒ function å‚æ•°ï¼Œä¸”æˆ‘ä»¬çš„ chunks æ˜¯å›ºå®šçš„ï¼Œä¾¿å¯ä»¥é€šè¿‡ä¸‹é¢è¿™æ ·çš„æ–¹å¼ä½¿ç”¨ï¼š
```js
Object.keys(config.entry).map((file) => {
    const chunks = ['manifest', 'vendor', 'commons', file]
    return new HtmlWebpackPlugin({
        chunks,
        filename: file + '.html',
        template: resolve('index.html'),
        inject: 'head',
        minify: {
        removeComments: true,
        collapseWhitespace: true,
        removeAttributeQuotes: true
        },
        chunksSortMode: (a, b) => chunks.indexOf(a.names[0]) - chunks.indexOf(b.names[0])
    })
})
```
åˆ°è¿™é‡Œï¼Œå…¶å®é€Ÿåº¦å·²ç»å¯ä»¥äº†ï¼Œä½†ä¸å®¹æ˜“æ»¡è¶³çš„æˆ‘å²‚ä¼šåˆ°è¿™é‡Œå°±ç»“æŸã€‚
ä¹‹å‰æ›¾åœ¨æ·˜å® FED çœ‹è¿‡ä¸€ç¯‡è®²`happypack`çš„æ–‡ç« ï¼Œhappypack æ˜¯ webpack çš„ä¸€ä¸ªæ’ä»¶ï¼Œç›®çš„æ˜¯é€šè¿‡å¤šè¿›ç¨‹æ¨¡å‹ï¼Œæ¥åŠ é€Ÿä»£ç æ„å»ºï¼Œå…·ä½“åŸç†å¯ä»¥çœ‹[è¿™é‡Œ](http://taobaofed.org/blog/2016/12/08/happypack-source-code-analysis/)ã€‚
happpack çš„ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼š  
```js
// webpack config
const HappyPack = require('happypack')
const os = require('os')

const config = {
    module: {
    rules: [
        {
        test: /\.js$/,
        loader: 'happypack/loader?id=js'
        }
    ]
    },
    plugins: [
    new HappyPack({
        id: 'js',
        // åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± å…±äº«ç»™æ‰€æœ‰çš„ HappyPack å®ä¾‹
        threadPool: HappyPack.ThreadPool({ size: os.cpus().length }),
        loaders: [{
        path: 'babel-loader',
        query: {
            cacheDirectory: true
        }
        }]
    })
    ]
}
```
è‡³æ­¤ä¸ºæ­¢ï¼Œæœ¬æ¬¡å¯¹æ„å»ºé€Ÿåº¦çš„ä¼˜åŒ–å°±ç»“æŸäº†ï¼Œæ•ˆæœå¦‚ä½•å‘¢ï¼Ÿå¼€å‘æ—¶ 1st æ„å»ºå¯ä»¥æ§åˆ¶åœ¨ 10s å·¦å³ï¼Œç”Ÿäº§æ„å»ºåœ¨ uglify + gzip çš„æƒ…å†µä¸‹ 1st æ„å»º 8sï¼Œæœ‰ cache çš„æƒ…å†µä¸‹æ”¹åŠ¨å•ä¸ªæ–‡ä»¶ 3.5sã€‚å¯ä»¥è¯´æ˜¯å¼€ä¸Šé£æœºå•¦ï¼

#### ç»“è¯­
å…¶å® webpack è¿˜æœ‰ä¸€äº›ä¼˜åŒ–ç©ºé—´ï¼Œæ¯”å¦‚ dllPluginï¼Œä¸è¿‡ç›®å‰çš„é€Ÿåº¦æˆ‘å·²ç»å¾ˆæ»¡è¶³äº†ğŸ˜ï¼Œç­‰åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªç“¶é¢ˆçš„æ—¶å€™å†å»ç ”ç©¶å§ã€‚å¦‚æœä½ æœ‰æ›´å¥½çš„ä¼˜åŒ–æ–¹æ³•ï¼Œæ¬¢è¿åˆ†äº«è¯„è®ºã€‚